name: Deploy Application

on:
  workflow_run:
    workflows: ["Build & Push Docker Images"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-notification:
    name: Deployment Status
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate deployment summary
        run: |
          echo "## ðŸš€ Deployment Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Using Docker Compose (Recommended for Single Server):**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Clone repository" >> $GITHUB_STEP_SUMMARY
          echo "git clone https://github.com/${{ github.repository }}.git" >> $GITHUB_STEP_SUMMARY
          echo "cd the-devops-deployment/mean-app" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Copy environment variables" >> $GITHUB_STEP_SUMMARY
          echo "cp .env.example .env" >> $GITHUB_STEP_SUMMARY
          echo "# Edit .env with your credentials" >> $GITHUB_STEP_SUMMARY
          echo "nano .env" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Deploy services" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose pull" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose up -d" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verify Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Check service status" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose ps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View logs" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose logs -f" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Access application" >> $GITHUB_STEP_SUMMARY
          echo "curl http://localhost/api/tutorials" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Health Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: http://localhost" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend API**: http://localhost:8080/api/tutorials" >> $GITHUB_STEP_SUMMARY
          echo "- **MongoDB**: Connected on port 27017" >> $GITHUB_STEP_SUMMARY

      - name: Post deployment status
        if: always()
        run: |
          echo "âœ“ Deployment pipeline completed successfully"

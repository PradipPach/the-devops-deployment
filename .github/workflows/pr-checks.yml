name: Pull Request Checks

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  lint-and-format:
    name: Lint & Code Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Backend - Install dependencies
        working-directory: mean-app/backend
        run: npm ci

      - name: Backend - Run ESLint
        working-directory: mean-app/backend
        run: npm run lint || echo "No linter configured"
        continue-on-error: true

      - name: Frontend - Install dependencies
        working-directory: mean-app/frontend
        run: npm ci

      - name: Frontend - Run ESLint
        working-directory: mean-app/frontend
        run: npm run lint || echo "No linter configured"
        continue-on-error: true

  test-coverage:
    name: Test Coverage Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Backend - Install dependencies
        working-directory: mean-app/backend
        run: npm ci

      - name: Backend - Run tests with coverage
        working-directory: mean-app/backend
        run: npm test -- --coverage || echo "No tests configured"
        continue-on-error: true

      - name: Frontend - Install dependencies
        working-directory: mean-app/frontend
        run: npm ci

      - name: Frontend - Run tests with coverage
        working-directory: mean-app/frontend
        run: npm test -- --coverage --watch=false --browsers=ChromeHeadless || echo "No tests configured"
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: mean-app/backend/coverage/lcov.info,mean-app/frontend/coverage/lcov.info
          flags: unittests
          fail_ci_if_error: false

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  docker-build-check:
    name: Docker Build Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: mean-app/backend
          file: mean-app/backend/Dockerfile
          push: false
          tags: mean-app-backend:pr-${{ github.event.pull_request.number }}

      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: mean-app/frontend
          file: mean-app/frontend/Dockerfile
          push: false
          tags: mean-app-frontend:pr-${{ github.event.pull_request.number }}

  compose-validation:
    name: Docker Compose Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose configuration
        working-directory: mean-app
        run: |
          docker-compose config > /dev/null
          echo "‚úì Docker Compose validation passed"

  comment-on-pr:
    name: Add PR Comment Summary
    runs-on: ubuntu-latest
    needs: [lint-and-format, test-coverage, security-scan, docker-build-check, compose-validation]
    if: always()

    steps:
      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const linting = '${{ needs.lint-and-format.result }}';
            const testing = '${{ needs.test-coverage.result }}';
            const security = '${{ needs.security-scan.result }}';
            const docker = '${{ needs.docker-build-check.result }}';
            const compose = '${{ needs.compose-validation.result }}';

            const comment = `
            ## üîç PR Validation Summary

            | Check | Status |
            |-------|--------|
            | Linting & Format | ${linting === 'success' ? '‚úÖ' : '‚ö†Ô∏è'} ${linting} |
            | Tests & Coverage | ${testing === 'success' ? '‚úÖ' : '‚ö†Ô∏è'} ${testing} |
            | Security Scan | ${security === 'success' ? '‚úÖ' : '‚ö†Ô∏è'} ${security} |
            | Docker Build | ${docker === 'success' ? '‚úÖ' : '‚ö†Ô∏è'} ${docker} |
            | Compose Valid | ${compose === 'success' ? '‚úÖ' : '‚ö†Ô∏è'} ${compose} |

            **Overall**: All checks ${[linting, testing, security, docker, compose].every(s => s === 'success' || s === 'skipped') ? '‚úÖ PASSED' : '‚ö†Ô∏è NEED ATTENTION'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
